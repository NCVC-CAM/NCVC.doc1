%!TEX root = ../NCVC.tex

\mysection{パワーユーザ編}

\subsection{スクリプト作成のすすめ}

\subsubsection{まえがき}
　awk(オーク), Perl(パール), Ruby(ルビー)これらの名前を聞いたことがあるでしょうか？
この3つを知らなくても，BasicやC/C++なら聞いたことがあるかと思います．
これら全てプログラミング言語で，先に挙げた3つの言語は特にテキストファイルの処理に優れた能力を発揮し，しかもそれらの処理を簡単に記述できるという特徴を持ったプログラミング言語です．

　さて，「プログラミング言語」と聞いて尻込みしているアナタ！
それは大きな誤解と難しいという先入観だと思います．
冒頭でも述べた通り，テキストファイルの処理に優れた能力を発揮できる非常に良く考えられた言語で，
目的にもよりますが極端な話し，たった1行でも十分実用可能なプログラムを作成することができます．
\ref{sec:multi-layer}節で少しだけ登場した正規表現がサポートされているので強力な文字列のパターンマッチングが可能，
つまり，テキストファイルの中から必要な情報を検索したり置換するといったことが簡単に記述できます．

　これがNCVCの解説書とどう関係があるのか？
答えは簡単，NCVCが吐くGコードがショボイから（自爆）...たしかにそれもありますが（汗），
例えば特殊なコード変換や埋め込み，サポートされていない機能の補間など，小粒だがピリリと気の利いた自分専用のツールを作ってみよう！
というのがこの章の目的です．
そう，Gコード（NCファイル）はテキストファイルです．
プログラミング可能な一定のルールがあるなら，もうメモ帳でシコシコ手修正する必要はありません．
\\ \\
　本解説書では，BasicやC/C++のプログラミング言語と区別するため，以後，スクリプト言語と称します．

\subsubsection{例題}
　とエラそうなことを書きましたが，ここで言語仕様等を書いてはキリが無いので，言語自体の解説は専門書にオマカセします．
また，スクリプト言語といえばPerlが有名ですが，著者はawkヲタク．
例題もただの検索や置換だけならメモ帳でもできるので，ちょっと複雑な例題を用意しました．
おかげで前述の「たった１行でも」というフレーズは実現できませんでした（ゴメンナサイ）．

　では早速例題のテーマですが，『シーケンス番号の追加』とします．
NCVCにもシーケンス番号を付加する生成オプションがありますが，コメント行などお構いなしに付加するため，この例題では次に示す行にシーケンス番号を付加しない仕様とします．

\begin{itemize}
\item O番号（プログラム番号），``\,\%\,''，カッコ``\,(\,''で始まる行
\item 空行
\end{itemize}

　awkスクリプトで書くと以下のようなリストになります．
これをメモ帳などで入力し，ファイルとして保存しておきましょう．
一見して解る通り，BasicやC/C++では必要なファイルのオープンや1行ずつ読み込んでループ等の処理は必要ありません．
awkで必要なのは条件パターンとその条件に対する処理（アクション）だけです．

\newpage
\begin{lstlisting}[caption=num.awk,numbers=none,label=lst:num.awk]
BEGIN {         # 最初に実行されるブロック
　　num=1000;       # シーケンス番号の初期値
　　add=5;          # 増分値
}
/^O|^\(|^%/ || length($0)==0 {  # シーケンス番号を付加しない条件
　　print $0                    # 1行そのまま出力（$0は入力1行全てを表す）
　　next                        # 次の処理（入力）へ
}
{                               # 条件パターン無しブロック（上記条件以外）
　　printf("N%04d", num);       # N に続く4桁の数字を出力（改行無し）
　　print $0;                   # 1行そのまま出力
　　num += add;                 # 増分の加算
}
\end{lstlisting}

\subsubsection{実行環境}
　もともとこれらスクリプト言語はUNIX文化で培われたものです．
UNIXにはほぼ標準で用意されていますが，Windowsで実行するには，それぞれの処理系をインストールする必要があります．
awkならGNUawk(gawk)が有名ですのでインストールしておいて下さい
\footnote{大規模なシステムではないので，展開して実行ファイル（EXE）をパスの通ったフォルダに移動させる，もしくはスクリプトと同じ場所に置くだけで良い}．

　実行環境が整えば，Windowsスタートメニューからコマンドプロンプト
\footnote{Windowsのバージョンによって違います．DOS窓のこと}
を開き，以下のように入力します．

\vspace*{1zh}
\begin{shadebox}
gawk -f \textit{ScriptName}.awk \textless \textit{Input-file}
\end{shadebox}

\vspace*{1zh}
　希望通りに変換されたGコードが表示されましたか？
必要なら

\vspace*{1zh}
\begin{shadebox}
gawk -f \textit{ScriptName}.awk \textless \textit{Input-file} \textgreater \textit{Output-file}
\end{shadebox}

\vspace*{1zh}
とすることで，\textit{Output-file} に示すファイルに書き出されます．

\subsubsection{あとがき}
　これくらいの例題だけでは，自分がしたい処理を書くことは正直難しいと思います．
けれども，スクリプト言語はGコードの置換処理だけでなくその他事務処理等にも応用できます．
得られるものは大きいのでぜひチャレンジしてみて下さい．

　新たに挑戦する場合は先人たちの知恵が大いに参考になると思います．
NCVCのWebページにはたくさんのスクリプトが掲載されていますのでご参考に．
また，NCVCからスクリプトが簡単に実行できるラッパーもあります．Scriptoriumのドキュメントも併せてご参考に．

\subsection{アドイン作成のすすめ}
\label{sec:addin}
　アドイン作成とはDLLの作成を意味し，NCVC本体の機能を内部的に拡張することができます．
前節のスクリプト言語とは対照的に高度なプログラミング知識が要求されますので，「DLLって何？」という方は表\ref{table:addin} の一覧だけ眺めてあとは読み飛ばしてもかまいません．

　さてアドインの作成ですが，NCVCのWebページからSDKをダウンロードし，インクルードファイルとインポートライブラリを各開発環境にインストールして下さい．
基本的にメニューイベント型のアドイン，つまり，アドイン側の初期化関数内で必要なメニューを登録し，メニューが選択されたときNCVCから登録された関数が呼ばれるという仕組みです．
関数一覧などSDKの詳細は別途SDKマニュアルを参照して下さい．

　【アドイン作成のすすめ】のタイトル通り，アドインによる機能拡張の有効性，特にCADデータのインポートについて述べると，『DXF形式で保存する必要が無くなる』が上げられます．
加工データ生成の初期段階ではCADソフトとの連携が重要ですが，\ref{sec:DesignCAD}節で述べたとおりCADソフト独自形式とDXF形式と併用しての保存は非常に煩わしいと感じるでしょう．
さらに，NCVCには現在開いているファイルがNCVC以外で変更されると，その変更を検知してアナウンスする機能があります．
CADソフト独自形式をインポートできることで，この機能を有効に使うことができます．

　ということで，ご使用CADのデータ形式が解ればぜひアドイン作成にチャレンジしてみましょう．
他，「こういう機能拡張を」というのがあれば腕試しにいかが？

\begin{table}[H]
\caption{アドイン一覧}
\label{table:addin}
\centering
\begin{tabular}{|l|l|l|}
\hline
\multicolumn{1}{|c|}{アドイン名} & \multicolumn{1}{c|}{概要} & \multicolumn{1}{c|}{備考} \\ \hline \hline
SendNCD    & Gコードのシリアル送信 & インストーラ付属 \\ \hline
ReadJW     & Jw\_cadデータ（JWC/JWW）のインポート & 　〃 \\ \hline
ReadCSV    & CSV形式の座標データインポート & 次回インストーラ付属 \\ \hline \hline
ReadDWG    & AutoCADデータ（DWG）のインポート & 開発中断（中止） \\ \hline
SolveTSP   & 巡回セールスマン問題の解法を用いた穴加工の移動最適化 & プロト完成後開発一時中断 \\ \hline
ReadGerber & 基板加工データ（ガーバー）のインポート & 構想のみ \\ \hline
\end{tabular}
\end{table}
